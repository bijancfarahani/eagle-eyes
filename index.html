<!DOCTYPE html>
<html>

<head>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser-arcade-physics.min.js"></script>
</head>

<body>

    <script>
        class EagleEyesTitle extends Phaser.Scene {
            preload() {
                this.load.setBaseURL("assets/");
                this.load.image('back_card', 'cards/back.png');
            }
            create() {
                this.add.text(0, 0, 'Welcome to Eagle Eyes!', { fontSize: '48px', fontFamily: 'Georgia, "Goudy Bookletter 1911", Times, serif' });
                const card_sprite = this.add.sprite(400, 400, 'back_card');
                card_sprite.setInteractive().on(
                    "pointerdown",
                    function (pointer, localX, localY, event) {
                        this.scene.start('memorization');
                    }, this
                );

            }
        }

        class EagleEyesMemorization extends Phaser.Scene {
            preload() {
                this.load.setBaseURL("assets/");
                this.load.image('back_card', 'cards/back.png');
                this.load.image('e_card', 'cards/e.png');
                this.load.image('a_card', 'cards/a.png');
                this.load.image('g_card', 'cards/g.png');
                this.load.image('l_card', 'cards/l.png');
                this.load.image('y_card', 'cards/y.png');
                this.load.image('s_card', 'cards/s.png');
            }

            create() {
                const answer = 'eagleeyes';
                const answer_chars = answer.split("");
                answer_chars.sort(() => 0.5 - Math.random());
                const scrambled = answer_chars.join("");
                for (var letter_index = 0; letter_index < scrambled.length; ++letter_index) {
                    const letter = scrambled[letter_index];
                    const card_key = letter + '_card';

                    const card_sprite = this.add.sprite(250 + (letter_index * 300), 300, card_key);
                }

                function on_memorization_timer_expire() {
                    console.log(this);
                    this.scene.start("cardSelection");
                }

                var timer = this.time.addEvent({
                    delay: 1 * 1000, // ms
                    callback: on_memorization_timer_expire,
                    //args: [],
                    callbackScope: this,
                    loop: false,
                });

            }
        }

        class EagleEyesCardSelection extends Phaser.Scene {
            preload() {
                this.load.setBaseURL("assets/");
                this.load.image('back_card', 'cards/back.png');
                this.load.image('e_card', 'cards/e.png');
                this.load.image('a_card', 'cards/a.png');
                this.load.image('g_card', 'cards/g.png');
                this.load.image('l_card', 'cards/l.png');
                this.load.image('y_card', 'cards/y.png');
                this.load.image('s_card', 'cards/s.png');
            }

            create() {
                class CardSprite extends Phaser.GameObjects.Sprite {
                    constructor(scene, x, y, texture, frame) {
                        super(scene, x, y, texture, frame);
                        scene.add.existing(this);
                        this.card_key = texture;
                        this.animationConfig = {
                            // Note: There are warnings for duplicates for 'e' (as expected).
                            key: "cardflip" + this.card_key,

                            frames: [
                                {
                                    key: this.card_key,
                                    frame: 0,
                                    duration: 1000
                                },
                                {
                                    key: 'back_card',
                                    frame: 0,
                                    duration: 1000
                                }
                            ]
                        };

                        scene.anims.create(this.animationConfig);
                    }

                    flipCard(pointer, localX, localY, event) {
                        console.log('clicked: ' + this.card_key);
                        this.play("cardflip" + this.card_key);
                    }
                }


                const DECK_STRING = 'eagleeyes';
                for (var letter_index = 0; letter_index < DECK_STRING.length; ++letter_index) {
                    const letter = DECK_STRING[letter_index];
                    const card_key = letter + '_card';

                    const card_sprite = new CardSprite(this, 250 + (letter_index * 300), 300, card_key);
                    card_sprite.setInteractive().on(
                        "pointerdown", card_sprite.flipCard
                    );
                }
            }
        }

        const config = {
            type: Phaser.AUTO,
            width: 1280,
            height: 720,
            scene: [
                new EagleEyesTitle("title"),
                new EagleEyesMemorization("memorization"),
                new EagleEyesCardSelection("cardSelection")]
        };

        const game = new Phaser.Game(config);
    </script>

</body>

</html>